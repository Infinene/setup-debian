### mariadb ###
# Setup Repository
${SUDO} apt-get install apt-transport-https curl
${SUDO} mkdir -p /etc/apt/keyrings
${SUDO} curl -o /etc/apt/keyrings/mariadb-keyring.pgp 'https://mariadb.org/mariadb_release_signing_key.pgp'

mariadblist=/etc/apt/sources.list.d/mariadb.sources
if [ ! -f "$mariadblist" ]; then
	${SUDO} tee ${mariadblist} <<-_END_
	# MariaDB 11.8 repository list - created 2025-08-10 15:09 UTC
	# https://mariadb.org/download/
	X-Repolib-Name: MariaDB
	Types: deb
	# deb.mariadb.org is a dynamic mirror if your preferred mirror goes offline. See https://mariadb.org/mirrorbits/ for details.
	# URIs: https://deb.mariadb.org/${mariadb_ver}/debian
	URIs: https://mirror.rackspace.com/mariadb/repo/${mariadb_ver}/debian
	Suites: trixie
	Components: main
	Signed-By: /etc/apt/keyrings/mariadb-keyring.pgp
	_END_
else
	echo "mariadb.sources alreay exists..."
	${SUDO} cat $mariadblist
	echo
	printf "\n%s" "Press enter to continue"
	read key
fi

# Install
${SUDO} apt update
${SUDO} apt -y install mariadb-server
${SUDO} cp -rbv $setup_dir/src/etc/mysql/* /etc/mysql/

password=$(whiptail --passwordbox "Enter a password for '${USER}': " 8 0 --title "MariaDB admin password"  3>&1 1>&2 2>&3)
password2=$(whiptail --passwordbox "Re-Enter password for '${USER}': " 8 0 --title "MariaDB admin password"  3>&1 1>&2 2>&3)

if [ "$password" =  "$password2" ]; then
	echo "Creating MariaDB user $USER and Granting all privileges to this account ..."
	${SUDO} mariadb -e "CREATE USER ${USER}@'%' IDENTIFIED BY '${password}'; \
	GRANT ALL PRIVILEGES ON *.* TO ${USER}@'%' WITH GRANT OPTION;"
else
	echo "User not created: canceled or passwords do not match."
	echo "Create user manually if needed"
fi
